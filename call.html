<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Son of Wisdom â€” Call</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="sow-shell page-call">
  <!-- App bar -->
  <header class="appbar">
    <!-- Back to main chat (same thread) -->
    <button
      id="btn-back-home"
      class="icon-btn"
      aria-label="Back to chat"
      title="Back to chat"
      type="button"
    >
      <span style="display:inline-block;font-size:22px;line-height:1;">Ã—</span>
    </button>

    <div class="powered tiny">
      powered by <span class="brand-mini">Son of Wisdom</span>
    </div>

    <!-- This gets wired by call.js once we know conversationId -->
    <a id="thread-link" class="btn small" href="#" style="display:none;">
      Return to conversation
    </a>
  </header>

  <!-- Main content: call card + right-hand transcript panel -->
  <main class="content call-layout" role="main">
    <!-- Left: call card -->
    <section class="call-main">
      <section class="hero-mini">
        <h1 class="hero-mini-title">Call with AI Blake</h1>
        <p class="hero-mini-tagline">
          Voice-to-voice coaching for the warrior heart.
        </p>
      </section>

      <section>
        <div class="call-card">
          <!-- Avatar + animated ring -->
          <div class="call-avatar-wrap" id="avatar-container">
            <canvas id="voiceRing"></canvas>
            <img src="avatar-blake.jpg" alt="AI Blake" class="call-avatar-img" />
          </div>

          <!-- Status + timer -->
          <div class="call-status">
            <span id="status-text">Tap the blue call button to begin.</span>
          </div>
          <div class="call-timer" id="call-timer">00:00</div>

          <!-- Hidden in-call transcript (still needed for JS hooks) -->
          <div id="transcript" class="call-transcript" style="display:none;">
            <div id="transcript-list" class="transcript-list"></div>
            <div id="transcript-interim" class="transcript-interim"></div>
          </div>

          <!-- Call controls -->
          <div class="call-controls">
            <button
              id="call-btn"
              class="btn circle call-toggle primary"
              type="button"
              aria-pressed="false"
              aria-label="Start call"
            >
              ðŸ“ž
            </button>

            <button
              id="mic-btn"
              class="btn circle"
              type="button"
              aria-pressed="false"
              aria-label="Toggle microphone"
            >
              ðŸŽ™
            </button>

            <button
              id="speaker-btn"
              class="btn circle"
              type="button"
              aria-pressed="true"
              aria-label="Toggle speaker"
            >
              ðŸ”Š
            </button>
          </div>

          <!-- Mode toggle -->
          <div class="row" style="margin-top:0.75rem;justify-content:center;gap:0.5rem;">
            <button
              id="mode-btn"
              class="btn pill small"
              type="button"
              aria-pressed="false"
              title="Switch to Chat (same conversation)"
            >
              Switch to Chat
            </button>
          </div>

          <!-- Chat panel is injected dynamically by call.js -->
        </div>
      </section>
    </section>

    <!-- Right-hand live transcript panel -->
    <aside class="call-side-transcript" aria-label="Live transcription">
      <iframe
        id="callTranscriptFrame"
        src="transcript.html?embed=1"
        title="Live call transcription"
        loading="lazy"
      ></iframe>
    </aside>
  </main>

  <footer class="sow-footer tiny">
    Built for sons, warriors, and kings learning to govern their homes.
  </footer>

  <!-- Back to home (same conversation) + optional iframe param wiring -->
  <script type="module">
    const params = new URLSearchParams(window.location.search);
    const conversationId = params.get("c");

    // Preserve conversation when leaving call mode
    const backBtn = document.getElementById("btn-back-home");
    if (backBtn) {
      backBtn.addEventListener("click", (e) => {
        e.preventDefault();
        const url = new URL("home.html", window.location.origin);
        if (conversationId) url.searchParams.set("c", conversationId);
        window.location.replace(url.toString());
      });
    }

    // Nice-to-have: if call.js stored last_call_id, include it for initial transcript load
    const frame = document.getElementById("callTranscriptFrame");
    try {
      const callId = window.localStorage.getItem("last_call_id");
      if (frame && callId) {
        const u = new URL(frame.getAttribute("src"), window.location.origin);
        u.searchParams.set("call_id", callId);
        frame.setAttribute("src", u.toString().replace(window.location.origin, ""));
      }
    } catch (e) {
      // ignore
    }
  </script>

  <!-- App logic -->
  <script type="module" src="app/call.js"></script>
</body>
</html>
