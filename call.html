<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Son of Wisdom â€” Call</title>

  <!-- iOS/Safari + mobile niceties -->
  <meta name="theme-color" content="#0b0f14" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <link rel="stylesheet" href="style.css" />
</head>

<body class="sow-shell page-call">
  <!-- App bar -->
  <header class="appbar">
    <!-- Back to main chat (same thread) -->
    <button
      id="btn-back-home"
      class="icon-btn"
      aria-label="Back to chat"
      title="Back to chat"
      type="button"
    >
      <span style="display:inline-block;font-size:22px;line-height:1;">Ã—</span>
    </button>

    <div class="powered tiny">
      powered by <span class="brand-mini">Son of Wisdom</span>
    </div>

    <a id="thread-link" class="btn small" href="#" style="display:none;">
      Return to conversation
    </a>
  </header>

  <!-- Main content -->
  <main class="content call-layout" role="main">
    <!-- Left: call card -->
    <section class="call-main">
      <section class="hero-mini">
        <h1 class="hero-mini-title">Call with AI Blake</h1>
        <p class="hero-mini-tagline">
          Voice-to-voice coaching for the warrior heart.
        </p>
      </section>

      <section>
        <div class="call-card">
          <!-- Avatar + animated ring -->
          <div class="call-avatar-wrap" id="avatar-container">
            <canvas id="voiceRing"></canvas>
            <img src="avatar-blake.jpg" alt="AI Blake" class="call-avatar-img" />
          </div>

          <!-- Status + timer -->
          <div class="call-status">
            <span id="status-text">Tap the blue call button to begin.</span>
          </div>
          <div class="call-timer" id="call-timer">00:00</div>

          <!-- âœ… Removed legacy transcript DOM entirely to prevent CSS conflicts -->

          <!-- Call controls (UPDATED: labels under buttons) -->
          <div class="call-controls labeled">
            <div class="call-control">
              <button
                id="call-btn"
                class="btn circle call-toggle primary"
                type="button"
                aria-pressed="false"
                aria-label="Start call"
              >
                ðŸ“ž
              </button>
              <div class="call-label" id="call-label">Start Call</div>
            </div>

            <div class="call-control">
              <button
                id="mic-btn"
                class="btn circle"
                type="button"
                aria-pressed="false"
                aria-label="Toggle microphone"
              >
                ðŸŽ™
              </button>
              <div class="call-label" id="mic-label">Mute</div>
            </div>

            <div class="call-control">
              <button
                id="speaker-btn"
                class="btn circle"
                type="button"
                aria-pressed="true"
                aria-label="Toggle speaker"
              >
                ðŸ”Š
              </button>
              <div class="call-label" id="speaker-label">Speaker</div>
            </div>
          </div>

          <!-- Mode toggle -->
          <div class="row" style="margin-top:0.75rem;justify-content:center;gap:0.5rem;">
            <button
              id="mode-btn"
              class="btn pill small"
              type="button"
              aria-pressed="false"
              title="Switch to Chat (same conversation)"
            >
              Switch to Chat
            </button>
          </div>

          <!-- Chat panel is injected dynamically by call.js -->
        </div>
      </section>
    </section>

    <!-- Right: live transcript panel -->
    <aside class="call-side-transcript" aria-label="Live transcription">
      <div class="transcript-wrap" style="height:100%;min-height:0;">
        <div class="ts-header" style="padding-bottom:0.45rem;">
          <div class="title-wrap">
            <div class="title-left">
              <span class="dot" aria-hidden="true"></span>
              <h1 style="margin:0;">Live Transcription</h1>
            </div>
            <div class="sub">
              <span class="live is-live">Live</span>
              <span class="muted">Updates as you speak</span>
            </div>
          </div>

          <div class="actions">
            <button id="ts-clear" class="ghost" type="button" title="Clear transcript">
              Clear
            </button>
          </div>
        </div>

        <!-- âœ… This is the only transcript DOM call.js uses -->
        <div id="tsList" class="ts-list" style="flex:1;min-height:0;">
          <div id="transcriptList" class="transcript-list"></div>
          <div id="transcriptInterim" class="transcript-interim"></div>
        </div>

        <div class="ts-footer">
          <div class="row">
            <span>Auto-scroll</span>
            <button id="ts-autoscroll" class="btn small ghost" type="button" aria-pressed="true">
              On
            </button>
          </div>
          <span class="hint">
            Tip: Press <code>c</code> to return to chat.
          </span>
        </div>
      </div>
    </aside>
  </main>

  <footer class="sow-footer tiny">
    Built for sons, warriors, and kings learning to govern their homes.
  </footer>

  <!-- Back to home (same conversation) -->
  <script type="module">
    const params = new URLSearchParams(window.location.search);
    const conversationId = params.get("c");

    const backBtn = document.getElementById("btn-back-home");
    if (backBtn) {
      backBtn.addEventListener("click", (e) => {
        e.preventDefault();
        const url = new URL("home.html", window.location.origin);
        if (conversationId) url.searchParams.set("c", conversationId);
        window.location.replace(url.toString());
      });
    }

    const threadLink = document.getElementById("thread-link");
    if (threadLink && conversationId) {
      const url = new URL("home.html", window.location.origin);
      url.searchParams.set("c", conversationId);
      threadLink.href = url.toString();
      threadLink.style.display = "inline-flex";
    }
  </script>

  <!-- App logic (module) -->
  <script type="module" src="app/call.js"></script>
</body>
</html>
